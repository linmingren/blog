  如果你在开发电商系统，那么计算环比和同比增速是常见的需求。下面通过一个简化的每日收入表， 来演示怎么计算环比。
  
  ```sql 
   create table revenue (
      id int primary key auto_increment,
      revenue decimal(10,2) not null,
      day date not null
    );
    
    insert into revenue (revenue, day)
    values (10000, "2020-02-08"),
    (12000, "2020-02-09"),
    (15000, "2020-02-10"),
    (25000, "2020-02-11"),
    (18000, "2020-02-12"),
    (20000, "2020-02-13"),
    (25000, "2020-02-14"),
    (30000, "2020-02-15"),
    (35000, "2020-02-16"),
    (40000, "2020-02-17"),
    (35000, "2020-02-18");
  ```
   为了计算环比，我们需要把当前行的收入和上一行的收入进行比较， 那么怎么拿到上一行的收入呢？ 这正是窗口函数lag的功能。下面的lag(revenue, 1)表示取上一个revenue列的值。
   
   
  ```sql 
 select day,
        revenue,
        lag(revenue, 1) over () as pre_revenue
 from revenue
 order by day
  ```

 查询结果如下。
  
  ```concept
# day, revenue, pre_revenue
'2020-02-08', '10000.00', NULL
'2020-02-09', '12000.00', '10000.00'
'2020-02-10', '15000.00', '12000.00'
'2020-02-11', '25000.00', '15000.00'
'2020-02-12', '18000.00', '25000.00'
'2020-02-13', '20000.00', '18000.00'
'2020-02-14', '25000.00', '20000.00'
'2020-02-15', '30000.00', '25000.00'
'2020-02-16', '35000.00', '30000.00'
'2020-02-17', '40000.00', '35000.00'
'2020-02-18', '35000.00', '40000.00'
```

有了lag函数，计算环比就简单了.

```sql
 select day,
        revenue,
        100 * (revenue - lag(revenue, 1) over ()) / (lag(revenue, 1) over ()) as growth
 from revenue
 order by day
```
 最后的结果如下。
```concept
# day, revenue, growth
'2020-02-08', '10000.00', NULL
'2020-02-09', '12000.00', '20.000000'
'2020-02-10', '15000.00', '25.000000'
'2020-02-11', '25000.00', '66.666667'
'2020-02-12', '18000.00', '-28.000000'
'2020-02-13', '20000.00', '11.111111'
'2020-02-14', '25000.00', '25.000000'
'2020-02-15', '30000.00', '20.000000'
'2020-02-16', '35000.00', '16.666667'
'2020-02-17', '40000.00', '14.285714'
'2020-02-18', '35000.00', '-12.500000'
```




